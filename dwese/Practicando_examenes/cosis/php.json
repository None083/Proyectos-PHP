{
  "__login": {
    "prefix": "__login",
    "body": [
      "function login(\\$usario,\\$clave)",
      "{",
      "    try{",
      "        \\$conexion= new PDO(\"mysql:host=\".SERVIDOR_BD.\";dbname=\".NOMBRE_BD,USUARIO_BD,CLAVE_BD,array(PDO::MYSQL_ATTR_INIT_COMMAND=>\"SET NAMES 'utf8'\"));",
      "    }",
      "    catch(PDOException \\$e){",
      "        \\$respuesta[\"error\"]=\"Imposible conectar:\".\\$e->getMessage();",
      "        return \\$respuesta;",
      "    }",
      "",
      "    try{",
      "        \\$consulta=\"select * from usuarios where usuario=? and clave=?\";",
      "        \\$sentencia=\\$conexion->prepare(\\$consulta);",
      "        \\$sentencia->execute([\\$usario,\\$clave]);",
      "    }",
      "    catch(PDOException \\$e){",
      "        \\$respuesta[\"error\"]=\"Imposible realizar la consulta:\".\\$e->getMessage();",
      "        \\$sentencia=null;",
      "        \\$conexion=null;",
      "        return \\$respuesta;",
      "    }",
      "    ",
      "    if(\\$sentencia->rowCount()>0)",
      "    {",
      "        \\$respuesta[\"usuario\"]=\\$sentencia->fetch(PDO::FETCH_ASSOC);",
      "    ",
      "    ",
      "        \\$payload=['exp'=>time()+3600,'data'=> \\$respuesta[\"usuario\"][\"id_usuario\"]];",
      "        \\$jwt = JWT::encode(\\$payload,PASSWORD_API,'HS256');",
      "        \\$respuesta[\"token\"]=\\$jwt;",
      "    }",
      "        ",
      "    else",
      "        \\$respuesta[\"mensaje\"]=\"El usuario no se encuentra registrado en la BD\";",
      "",
      "",
      "    \\$sentencia=null;",
      "    \\$conexion=null;",
      "    return \\$respuesta;",
      "}"
    ]
  },
  "__seguridad": {
    "prefix": "__seguridad",
    "body": [
      "\\$url=DIR_SERV.\"/logueado\";",
      "\\$headers[] = 'Authorization: Bearer '.\\$_SESSION[\"token\"];",
      "\\$respuesta=consumir_servicios_JWT_REST(\\$url,\"GET\",\\$headers);",
      "\\$json_login=json_decode(\\$respuesta,true);",
      "if(!\\$json_login)",
      "{",
      "session_destroy();",
      "die(error_page(\"Actividad 6\",\"<p>Error consumiendo el Servicio Web: <strong>\".\\$url.\"</strong></p>\"));",
      "}",
      "",
      "if(isset(\\$json_login[\"no_auth\"]))",
      "{",
      "session_unset();",
      "\\$_SESSION[\"mensaje_seguridad\"]=\"El tiempo de sesión de la API ha caducado\";",
      "header(\"Location:index.php\");",
      "exit;",
      "}",
      "",
      "if(isset(\\$json_login[\"error\"]))",
      "{",
      "session_destroy();",
      "die(error_page(\"Actividad 6\",\"<p>\".\\$json_login[\"error\"].\"</p>\"));",
      "}",
      "",
      "",
      "if(isset(\\$json_login[\"mensaje_baneo\"]))",
      "{",
      "session_unset();//Me deslogueo",
      "\\$_SESSION[\"mensaje_seguridad\"]=\"Usted ya no se encuentra registrado en la BD\";",
      "header(\"Location:index.php\");",
      "exit;",
      "}",
      "",
      "",
      "// He pasado el control de baneo",
      "// Dejo la conexión abierta y aprovecho para coger datos del usuario logueado",
      "",
      "\\$datos_usuario_log=\\$json_login[\"usuario\"];",
      "\\$_SESSION[\"token\"]=\\$json_login[\"token\"];",
      "",
      "",
      "",
      "// Ahora controlo el tiempo de inactividad",
      "",
      "if(time()-\\$_SESSION[\"ultm_accion\"]>INACTIVIDAD*60)",
      "{",
      "session_unset();//Me deslogueo",
      "\\$_SESSION[\"mensaje_seguridad\"]=\"Su tiempo de sesión ha expirado. Por favor, vuelva a loguearse\";",
      "header(\"Location:index.php\");",
      "exit;",
      "}",
      "",
      "\\$_SESSION[\"ultm_accion\"]=time();"
    ]
  },
  "__obtener_productos": {
    "prefix": "__obtener_productos",
    "body": [
      "function obtener_productos()",
      "{",
      "    try{",
      "        \\$conexion=new PDO(\"mysql:host=\".SERVIDOR_BD.\";dbname=\".NOMBRE_BD,USUARIO_BD,CLAVE_BD,array(PDO::MYSQL_ATTR_INIT_COMMAND => \"SET NAMES 'utf8'\"));",
      "    }",
      "    catch(PDOException \\$e)",
      "    {",
      "        \\$respuesta[\"error\"]=\"No he podido conectarse a la base de batos: \".\\$e->getMessage();",
      "        return \\$respuesta;",
      "    }",
      "",
      "    try{",
      "        \\$consulta=\"select * from producto\";",
      "        \\$sentencia=\\$conexion->prepare(\\$consulta);",
      "        \\$sentencia->execute();",
      "",
      "    }",
      "    catch(PDOException \\$e)",
      "    {",
      "        \\$sentencia=null;",
      "        \\$conexion=null;",
      "        \\$respuesta[\"error\"]=\"No he podido realizarse la consulta: \".\\$e->getMessage();",
      "        return \\$respuesta;",
      "    }",
      "",
      "    \\$respuesta[\"productos\"]=\\$sentencia->fetchAll(PDO::FETCH_ASSOC);",
      "    \\$sentencia=null;",
      "    \\$conexion=null;",
      "    return \\$respuesta;",
      "}"
    ]
  },
  "__obtener_producto_cod": {
    "prefix": "__obtener_producto_cod",
    "body": [
      "function obtener_producto(\\$cod)",
      "{",
      "try{",
      "\\$conexion=new PDO(\"mysql:host=\".SERVIDOR_BD.\";dbname=\".NOMBRE_BD,USUARIO_BD,CLAVE_BD,array(PDO::MYSQL_ATTR_INIT_COMMAND => \"SET NAMES 'utf8'\"));",
      "}",
      "catch(PDOException \\$e)",
      "{",
      "\\$respuesta[\"error\"]=\"No he podido conectarse a la base de batos: \".\\$e->getMessage();",
      "return \\$respuesta;",
      "}",
      "try{",
      "\\$consulta=\"select producto.*, familia.nombre as nombre_familia from producto, familia where producto.familia=familia.cod and producto.cod=?\";",
      "\\$sentencia=\\$conexion->prepare(\\$consulta);",
      "\\$sentencia->execute([\\$cod]);",
      "",
      "}",
      "catch(PDOException \\$e)",
      "{",
      "\\$sentencia=null;",
      "\\$conexion=null;",
      "\\$respuesta[\"error\"]=\"No he podido realizarse la consulta: \".\\$e->getMessage();",
      "return \\$respuesta;",
      "}",
      "if(\\$sentencia->rowCount()<=0)",
      "    \\$respuesta[\"mensaje\"]=\"El producto con cod: \" .\\$cod.\" no se encuentra en la BD\";",
      "    else",
      "    \\$respuesta[\"producto\"]=\\$sentencia->fetch(PDO::FETCH_ASSOC);",
      "",
      "    \\$sentencia=null;",
      "    \\$conexion=null;",
      "    return \\$respuesta;",
      "    }"
    ]
  },
  "__insertar_producto": {
    "prefix": "__insertar_producto",
    "body": [
      "function insertar_producto(\\$datos)",
      "{",
      "try{",
      "\\$conexion=new PDO(\"mysql:host=\".SERVIDOR_BD.\";dbname=\".NOMBRE_BD,USUARIO_BD,CLAVE_BD,array(PDO::MYSQL_ATTR_INIT_COMMAND => \"SET NAMES 'utf8'\"));",
      "}",
      "catch(PDOException \\$e)",
      "{",
      "\\$respuesta[\"error\"]=\"No he podido conectarse a la base de batos: \".\\$e->getMessage();",
      "return \\$respuesta;",
      "}",
      "try{",
      "\\$consulta=\"insert into producto (cod, nombre, nombre_corto,descripcion,PVP, familia) values (?,?,?,?,?,?)\";",
      "\\$sentencia=\\$conexion->prepare(\\$consulta);",
      "\\$sentencia->execute(\\$datos);",
      "",
      "}",
      "catch(PDOException \\$e)",
      "{",
      "\\$sentencia=null;",
      "\\$conexion=null;",
      "\\$respuesta[\"error\"]=\"No he podido realizarse la consulta: \".\\$e->getMessage();",
      "return \\$respuesta;",
      "}",
      "",
      "\\$respuesta[\"mensaje\"]=\"El producto con cod: \".\\$datos[0].\" se ha insertado correctamente\";",
      "",
      "",
      "\\$sentencia=null;",
      "\\$conexion=null;",
      "return \\$respuesta;",
      "}"
    ]
  },
  "__actualizar_producto": {
    "prefix": "__actualizar_producto",
    "body": [
      "function actualizar_producto(\\$datos)",
      "{",
      "try{",
      "\\$conexion=new PDO(\"mysql:host=\".SERVIDOR_BD.\";dbname=\".NOMBRE_BD,USUARIO_BD,CLAVE_BD,array(PDO::MYSQL_ATTR_INIT_COMMAND => \"SET NAMES 'utf8'\"));",
      "}",
      "catch(PDOException \\$e)",
      "{",
      "\\$respuesta[\"error\"]=\"No he podido conectarse a la base de batos: \".\\$e->getMessage();",
      "return \\$respuesta;",
      "}",
      "try{",
      "\\$consulta=\"update producto set nombre=?, nombre_corto=?, descripcion=?, PVP=?, familia=? where cod=?\";",
      "\\$sentencia=\\$conexion->prepare(\\$consulta);",
      "\\$sentencia->execute(\\$datos);",
      "",
      "}",
      "catch(PDOException \\$e)",
      "{",
      "\\$sentencia=null;",
      "\\$conexion=null;",
      "\\$respuesta[\"error\"]=\"No he podido realizarse la consulta: \".\\$e->getMessage();",
      "return \\$respuesta;",
      "}",
      "",
      "\\$respuesta[\"mensaje\"]=\"El producto con cod: \".end(\\$datos).\" se ha actualizado correctamente\";",
      "",
      "",
      "\\$sentencia=null;",
      "\\$conexion=null;",
      "return \\$respuesta;",
      "}"
    ]
  },
  "__borrar_producto": {
    "prefix": "__borrar_producto",
    "body": [
      "function borrar_producto(\\$cod)",
      "{",
      "try{",
      "\\$conexion=new PDO(\"mysql:host=\".SERVIDOR_BD.\";dbname=\".NOMBRE_BD,USUARIO_BD,CLAVE_BD,array(PDO::MYSQL_ATTR_INIT_COMMAND => \"SET NAMES 'utf8'\"));",
      "}",
      "catch(PDOException \\$e)",
      "{",
      "\\$respuesta[\"error\"]=\"No he podido conectarse a la base de batos: \".\\$e->getMessage();",
      "return \\$respuesta;",
      "}",
      "try{",
      "\\$consulta=\"delete from producto where cod=?\";",
      "\\$sentencia=\\$conexion->prepare(\\$consulta);",
      "\\$sentencia->execute([\\$cod]);",
      "",
      "}",
      "catch(PDOException \\$e)",
      "{",
      "\\$sentencia=null;",
      "\\$conexion=null;",
      "\\$respuesta[\"error\"]=\"No he podido realizarse la consulta: \".\\$e->getMessage();",
      "return \\$respuesta;",
      "}",
      "",
      "\\$respuesta[\"mensaje\"]=\"El producto con cod: \".\\$cod.\" se ha borrado de la BD\";",
      "",
      "\\$sentencia=null;",
      "\\$conexion=null;",
      "return \\$respuesta;",
      "}"
    ]
  },
  "__repetido_insertando": {
    "prefix": "__repetido_insertando",
    "body": [
      "function repetido_insertando(\\$tabla,\\$columna,\\$valor)",
      "{",
      "try{",
      "\\$conexion=new PDO(\"mysql:host=\".SERVIDOR_BD.\";dbname=\".NOMBRE_BD,USUARIO_BD,CLAVE_BD,array(PDO::MYSQL_ATTR_INIT_COMMAND => \"SET NAMES 'utf8'\"));",
      "}",
      "catch(PDOException \\$e)",
      "{",
      "\\$respuesta[\"error\"]=\"No he podido conectarse a la base de batos: \".\\$e->getMessage();",
      "return \\$respuesta;",
      "}",
      "",
      "try{",
      "\\$consulta=\"select \".\\$columna.\" from \".\\$tabla.\" where \".\\$columna.\"=?\" ;",
      "\\$sentencia=\\$conexion->prepare(\\$consulta);",
      "\\$sentencia->execute([\\$valor]);",
      "",
      "}",
      "catch(PDOException \\$e)",
      "{",
      "\\$sentencia=null;",
      "\\$conexion=null;",
      "\\$respuesta[\"error\"]=\"No he podido realizarse la consulta: \".\\$e->getMessage();",
      "return \\$respuesta;",
      "}",
      "",
      "\\$respuesta[\"repetido\"]=\\$sentencia->rowCount()>0;",
      "",
      "",
      "\\$sentencia=null;",
      "\\$conexion=null;",
      "return \\$respuesta;",
      "}"
    ]
  },
  "__repetido_editando": {
    "prefix": "__repetido_editando",
    "body": [
      "function repetido_editando(\\$tabla,\\$columna,\\$valor,\\$columna_id,\\$valor_id)",
      "{",
      "try{",
      "\\$conexion=new PDO(\"mysql:host=\".SERVIDOR_BD.\";dbname=\".NOMBRE_BD,USUARIO_BD,CLAVE_BD,array(PDO::MYSQL_ATTR_INIT_COMMAND => \"SET NAMES 'utf8'\"));",
      "}",
      "catch(PDOException \\$e)",
      "{",
      "\\$respuesta[\"error\"]=\"No he podido conectarse a la base de batos: \".\\$e->getMessage();",
      "return \\$respuesta;",
      "}",
      "",
      "try{",
      "\\$consulta=\"select \".\\$columna.\" from \".\\$tabla.\" where \".\\$columna.\"=? and \".\\$columna_id.\"<>?\" ;",
      "    \\$sentencia=\\$conexion->prepare(\\$consulta);",
      "    \\$sentencia->execute([\\$valor,\\$valor_id]);",
      "",
      "    }",
      "    catch(PDOException \\$e)",
      "    {",
      "    \\$sentencia=null;",
      "    \\$conexion=null;",
      "    \\$respuesta[\"error\"]=\"No he podido realizarse la consulta: \".\\$e->getMessage();",
      "    return \\$respuesta;",
      "    }",
      "",
      "    \\$respuesta[\"repetido\"]=\\$sentencia->rowCount()>0;",
      "",
      "",
      "    \\$sentencia=null;",
      "    \\$conexion=null;",
      "    return \\$respuesta;",
      "    }"
    ]
  },
  "__ctes_servicios": {
    "prefix": "__ctes_servicios",
    "body": [
      "use Firebase\\JWT\\JWT;",
      "use Firebase\\JWT\\Key;",
      "",
      "require 'Firebase/autoload.php';",
      "",
      "define(\"SERVIDOR_BD\",\"localhost\");",
      "/*define(\"USUARIO_BD\",\"jose\");",
      "define(\"CLAVE_BD\",\"josefa\");*/",
      "define(\"USUARIO_BD\",\"root\");",
      "define(\"CLAVE_BD\",\"\");",
      "define(\"NOMBRE_BD\",\"bd_tienda\");",
      "define(\"PASSWORD_API\",\"PASSWORD_DE_MI_APLICACION\");"
    ]
  },
  "__principio_index_servicios": {
    "prefix": "__principio_index_servicios",
    "body": [
      "require __DIR__ . '/Slim/autoload.php';",
      "require \"src/funciones_CTES_servicios.php\";",
      "",
      "",
      "\\$app = new \\Slim\\App;",
      "",
      "",
      "",
      "",
      "",
      "",
      "",
      "",
      "",
      "",
      "\\$app->run();"
    ]
  },
  "__app_get_logueado": {
    "prefix": "__app_get_logueado",
    "body": [
      "\\$app->get('/logueado', function () {",
      "\\$test = validateToken();",
      "if (is_array(\\$test))",
      "echo json_encode(\\$test);",
      "else",
      "echo json_encode(array(\"no_auth\" => \"No tienes permisos para usar este servicio\"));",
      "});"
    ]
  },
  "__app_get_productos": {
    "prefix": "__app_get_productos",
    "body": [
      "\\$app->get('/productos', function () {",
      "\\$test = validateToken();",
      "if (is_array(\\$test))",
      "if (isset(\\$test[\"usuario\"]))",
      "if (\\$test[\"usuario\"][\"tipo\"] == \"admin\")",
      "echo json_encode(obtener_productos());",
      "else",
      "echo json_encode(array(\"no_auth\" => \"No tienes permisos para usar este servicio\"));",
      "else",
      "echo json_encode(\\$test);",
      "else",
      "echo json_encode(array(\"no_auth\" => \"No tienes permisos para usar este servicio\"));",
      "});"
    ]
  },
  "__app_post_login": {
    "prefix": "app_post_login",
    "body": [
      "\\$app->post('/login', function (\\$request) {",
      "",
      "\\$usuario = \\$request->getParam(\"usuario\");",
      "\\$clave = \\$request->getParam(\"clave\");",
      "echo json_encode(login(\\$usuario, \\$clave));",
      "});"
    ]
  },
  "__app_get_producto_cod": {
    "prefix": "__app_get_producto_cod",
    "body": [
      "\\$app->get('/producto/{codigo}', function (\\$request) {",
      "\\$test = validateToken();",
      "if (is_array(\\$test))",
      "if (isset(\\$test[\"usuario\"]))",
      "if (\\$test[\"usuario\"][\"tipo\"] == \"admin\") {",
      "\\$cod = \\$request->getAttribute(\"codigo\");",
      "echo json_encode(obtener_producto(\\$cod));",
      "} else",
      "echo json_encode(array(\"no_auth\" => \"No tienes permisos para usar este servicio\"));",
      "else",
      "echo json_encode(\\$test);",
      "else",
      "echo json_encode(array(\"no_auth\" => \"No tienes permisos para usar este servicio\"));",
      "});"
    ]
  },
  "__app_post_producto_insertar": {
    "prefix": "__app_post_producto_insertar",
    "body": [
      "\\$app->post('/producto/insertar', function (\\$request) {",
      "",
      "\\$test = validateToken();",
      "if (is_array(\\$test))",
      "if (isset(\\$test[\"usuario\"]))",
      "if (\\$test[\"usuario\"][\"tipo\"] == \"admin\") {",
      "\\$datos[] = \\$request->getParam(\"cod\");",
      "\\$datos[] = \\$request->getParam(\"nombre\");",
      "\\$datos[] = \\$request->getParam(\"nombre_corto\");",
      "\\$datos[] = \\$request->getParam(\"descripcion\");",
      "\\$datos[] = \\$request->getParam(\"PVP\");",
      "\\$datos[] = \\$request->getParam(\"familia\");",
      "",
      "echo json_encode(insertar_producto(\\$datos));",
      "} else",
      "echo json_encode(array(\"no_auth\" => \"No tienes permisos para usar este servicio\"));",
      "else",
      "echo json_encode(\\$test);",
      "else",
      "echo json_encode(array(\"no_auth\" => \"No tienes permisos para usar este servicio\"));",
      "});"
    ]
  },
  "__app_put_producto_actualizar": {
    "prefix": "__app_put_producto_actualizar",
    "body": [
      "\\$app->put('/producto/actualizar/{codigo}', function (\\$request) {",
      "",
      "\\$test = validateToken();",
      "if (is_array(\\$test))",
      "if (isset(\\$test[\"usuario\"]))",
      "if (\\$test[\"usuario\"][\"tipo\"] == \"admin\") {",
      "\\$datos[] = \\$request->getParam(\"nombre\");",
      "\\$datos[] = \\$request->getParam(\"nombre_corto\");",
      "\\$datos[] = \\$request->getParam(\"descripcion\");",
      "\\$datos[] = \\$request->getParam(\"PVP\");",
      "\\$datos[] = \\$request->getParam(\"familia\");",
      "\\$datos[] = \\$request->getAttribute(\"codigo\");",
      "",
      "echo json_encode(actualizar_producto(\\$datos));",
      "} else",
      "echo json_encode(array(\"no_auth\" => \"No tienes permisos para usar este servicio\"));",
      "else",
      "echo json_encode(\\$test);",
      "else",
      "echo json_encode(array(\"no_auth\" => \"No tienes permisos para usar este servicio\"));",
      "});"
    ]
  },
  "__app_delete_producto_borrar": {
    "prefix": "__app_delete_producto_borrar",
    "body": [
      "\\$app->delete('/producto/borrar/{codigo}', function (\\$request) {",
      "\\$test = validateToken();",
      "if (is_array(\\$test))",
      "if (isset(\\$test[\"usuario\"]))",
      "if (\\$test[\"usuario\"][\"tipo\"] == \"admin\") {",
      "\\$cod = \\$request->getAttribute(\"codigo\");",
      "echo json_encode(borrar_producto(\\$cod));",
      "} else",
      "echo json_encode(array(\"no_auth\" => \"No tienes permisos para usar este servicio\"));",
      "else",
      "echo json_encode(\\$test);",
      "else",
      "echo json_encode(array(\"no_auth\" => \"No tienes permisos para usar este servicio\"));",
      "});"
    ]
  },
  "__app_get_repetido_insertando": {
    "prefix": "__app_get_repetido_insertando",
    "body": [
      "\\$app->get('/repetido/{tabla}/{columna}/{valor}', function (\\$request) {",
      "",
      "\\$test = validateToken();",
      "if (is_array(\\$test))",
      "if (isset(\\$test[\"usuario\"]))",
      "if (\\$test[\"usuario\"][\"tipo\"] == \"admin\") {",
      "\\$tabla = \\$request->getAttribute(\"tabla\");",
      "\\$columna = \\$request->getAttribute(\"columna\");",
      "\\$valor = \\$request->getAttribute(\"valor\");",
      "echo json_encode(repetido_insertando(\\$tabla, \\$columna, \\$valor));",
      "} else",
      "echo json_encode(array(\"no_auth\" => \"No tienes permisos para usar este servicio\"));",
      "else",
      "echo json_encode(\\$test);",
      "else",
      "echo json_encode(array(\"no_auth\" => \"No tienes permisos para usar este servicio\"));",
      "});"
    ]
  },
  "__app_get_repetido_editando": {
    "prefix": "__app_get_repetido_editando",
    "body": [
      "\\$app->get('/repetido/{tabla}/{columna}/{valor}/{columna_id}/{valor_id}', function (\\$request) {",
      "",
      "\\$test = validateToken();",
      "if (is_array(\\$test))",
      "if (isset(\\$test[\"usuario\"]))",
      "if (\\$test[\"usuario\"][\"tipo\"] == \"admin\") {",
      "\\$tabla = \\$request->getAttribute(\"tabla\");",
      "\\$columna = \\$request->getAttribute(\"columna\");",
      "\\$valor = \\$request->getAttribute(\"valor\");",
      "\\$columna_id = \\$request->getAttribute(\"columna_id\");",
      "\\$valor_id = \\$request->getAttribute(\"valor_id\");",
      "echo json_encode(repetido_editando(\\$tabla, \\$columna, \\$valor, \\$columna_id, \\$valor_id));",
      "} else",
      "echo json_encode(array(\"no_auth\" => \"No tienes permisos para usar este servicio\"));",
      "else",
      "echo json_encode(\\$test);",
      "else",
      "echo json_encode(array(\"no_auth\" => \"No tienes permisos para usar este servicio\"));",
      "});"
    ]
  },
  "__validate_token": {
    "prefix": "__validate_token",
    "body": [
      "function validateToken()",
      "{",
      "",
      "\\$headers = apache_request_headers();",
      "if(!isset(\\$headers[\"Authorization\"]))",
      "return false;//Sin autorizacion",
      "else",
      "{",
      "\\$authorization = \\$headers[\"Authorization\"];",
      "\\$authorizationArray=explode(\" \",\\$authorization);",
      "\\$token=\\$authorizationArray[1];",
      "try{",
      "\\$info=JWT::decode(\\$token,new Key(PASSWORD_API,'HS256'));",
      "}",
      "catch(\\Throwable \\$th){",
      "return false;//Expirado",
      "}",
      "",
      "try{",
      "\\$conexion= new PDO(\"mysql:host=\".SERVIDOR_BD.\";dbname=\".NOMBRE_BD,USUARIO_BD,CLAVE_BD,array(PDO::MYSQL_ATTR_INIT_COMMAND=>\"SET NAMES 'utf8'\"));",
      "}",
      "catch(PDOException \\$e){",
      "",
      "\\$respuesta[\"error\"]=\"Imposible conectar:\".\\$e->getMessage();",
      "return \\$respuesta;",
      "}",
      "",
      "try{",
      "\\$consulta=\"select * from usuarios where id_usuario=?\";",
      "\\$sentencia=\\$conexion->prepare(\\$consulta);",
      "\\$sentencia->execute([\\$info->data]);",
      "}",
      "catch(PDOException \\$e){",
      "\\$respuesta[\"error\"]=\"Imposible realizar la consulta:\".\\$e->getMessage();",
      "\\$sentencia=null;",
      "\\$conexion=null;",
      "return \\$respuesta;",
      "}",
      "if(\\$sentencia->rowCount()>0)",
      "{",
      "\\$respuesta[\"usuario\"]=\\$sentencia->fetch(PDO::FETCH_ASSOC);",
      "",
      "\\$payload['exp']=time()+3600;",
      "\\$payload['data']= \\$respuesta[\"usuario\"][\"id_usuario\"];",
      "\\$jwt = JWT::encode(\\$payload,PASSWORD_API,'HS256');",
      "\\$respuesta[\"token\"]=\\$jwt;",
      "}",
      "",
      "else",
      "\\$respuesta[\"mensaje_baneo\"]=\"El usuario no se encuentra registrado en la BD\";",
      "",
      "\\$sentencia=null;",
      "\\$conexion=null;",
      "return \\$respuesta;",
      "}",
      "",
      "}"
    ]
  },
  "__funciones_ctes_app": {
    "prefix": "__funciones_ctes_app",
    "body": [
      "define(\"INACTIVIDAD\",5);",
      "define(\"DIR_SERV\",\"http://localhost/Proyectos/DWESE/M_A/SW/Actividad5/servicios_rest_protect\");",
      "function consumir_servicios_REST(\\$url,\\$metodo,\\$datos=null)",
      "{",
      "\\$llamada=curl_init();",
      "curl_setopt(\\$llamada,CURLOPT_URL,\\$url);",
      "curl_setopt(\\$llamada,CURLOPT_RETURNTRANSFER,true);",
      "curl_setopt(\\$llamada,CURLOPT_CUSTOMREQUEST,\\$metodo);",
      "if(isset(\\$datos))",
      "curl_setopt(\\$llamada,CURLOPT_POSTFIELDS,http_build_query(\\$datos));",
      "\\$respuesta=curl_exec(\\$llamada);",
      "curl_close(\\$llamada);",
      "return \\$respuesta;",
      "}",
      "",
      "function consumir_servicios_JWT_REST(\\$url,\\$metodo,\\$headers,\\$datos=null)",
      "{",
      "\\$llamada=curl_init();",
      "curl_setopt(\\$llamada,CURLOPT_URL,\\$url);",
      "curl_setopt(\\$llamada,CURLOPT_RETURNTRANSFER,true);",
      "curl_setopt(\\$llamada,CURLOPT_CUSTOMREQUEST,\\$metodo);",
      "curl_setopt(\\$llamada,CURLOPT_HTTPHEADER,\\$headers);",
      "if(isset(\\$datos))",
      "curl_setopt(\\$llamada,CURLOPT_POSTFIELDS,http_build_query(\\$datos));",
      "\\$respuesta=curl_exec(\\$llamada);",
      "curl_close(\\$llamada);",
      "return \\$respuesta;",
      "}",
      "function error_page(\\$title, \\$body)",
      "{",
      "return '",
      "<!DOCTYPE html>",
      "<html lang=\"es\">",
      "",
      "<head>",
      "    <meta charset=\"UTF-8\">",
      "    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">",
      "    <title>'.\\$title.'</title>",
      "</head>",
      "",
      "<body>'.\\$body.'</body>",
      "",
      "</html>';",
      "}"
    ]
  },
  "__header_authorization": {
    "prefix": "__header_authorization",
    "body": [
      "\\$headers[] = 'Authorization: Bearer '.\\$_SESSION[\"token\"];",
      "\\$url=DIR_SERV.\"/producto/borrar/\".urlencode(\\$_POST[\"btnContBorrar\"]);",
      "\\$respuesta=consumir_servicios_JWT_REST(\\$url,\"DELETE\",\\$headers);",
      "\\$json_borrar=json_decode(\\$respuesta,true);"
    ]
  },
  "__btn_cont_nuevo": {
    "prefix": "__btn_cont_nuevo",
    "body": [
      "if(isset(\\$_POST[\"btnContNuevo\"]))",
      "{",
      "\\$error_cod=\\$_POST[\"cod\"]==\"\" || strlen(\\$_POST[\"cod\"])>12;",
      "if(!\\$error_cod)",
      "{",
      "",
      "\\$headers[] = 'Authorization: Bearer '.\\$_SESSION[\"token\"];",
      "\\$url=DIR_SERV.\"/repetido/producto/cod/\".urlencode(\\$_POST[\"cod\"]);",
      "\\$respuesta=consumir_servicios_JWT_REST(\\$url,\"GET\",\\$headers);",
      "\\$json_repetido=json_decode(\\$respuesta,true);",
      "if(!\\$json_repetido)",
      "{",
      "session_destroy();",
      "die(error_page(\"Actividad 6\",\"<p>Error consumiendo el servico rest: <strong>\".\\$url.\"</strong></p>\"));",
      "}",
      "",
      "",
      "if(isset(\\$json_repetido[\"no_auth\"]))",
      "{",
      "session_unset();",
      "\\$_SESSION[\"mensaje_seguridad\"]=\"El tiempo de sesión de la API ha caducado\";",
      "header(\"Location:index.php\");",
      "exit;",
      "}",
      "",
      "if(isset(\\$json_repetido[\"error\"]))",
      "{",
      "session_destroy();",
      "die(error_page(\"Actividad 6\",\"<p>\".\\$json_repetido[\"error\"].\"</p>\"));",
      "}",
      "",
      "if(isset(\\$json_repetido[\"mensaje_baneo\"]))",
      "{",
      "session_unset();//Me deslogueo",
      "\\$_SESSION[\"mensaje_seguridad\"]=\"Usted ya no se encuentra registrado en la BD\";",
      "header(\"Location:index.php\");",
      "exit;",
      "}",
      "",
      "\\$error_cod=\\$json_repetido[\"repetido\"];",
      "}",
      "",
      "\\$error_nombre_corto=\\$_POST[\"nombre_corto\"]==\"\";",
      "if(!\\$error_nombre_corto)",
      "{",
      "\\$headers[] = 'Authorization: Bearer '.\\$_SESSION[\"token\"];",
      "\\$url=DIR_SERV.\"/repetido/producto/nombre_corto/\".urlencode(\\$_POST[\"nombre_corto\"]);",
      "\\$respuesta=consumir_servicios_JWT_REST(\\$url,\"GET\",\\$headers);",
      "\\$json_repetido=json_decode(\\$respuesta,true);",
      "if(!\\$json_repetido)",
      "{",
      "session_destroy();",
      "die(error_page(\"Actividad 6\",\"<p>Error consumiendo el servico rest: <strong>\".\\$url.\"</strong></p>\"));",
      "}",
      "",
      "",
      "if(isset(\\$json_repetido[\"no_auth\"]))",
      "{",
      "session_unset();",
      "\\$_SESSION[\"mensaje_seguridad\"]=\"El tiempo de sesión de la API ha caducado\";",
      "header(\"Location:index.php\");",
      "exit;",
      "}",
      "",
      "if(isset(\\$json_repetido[\"error\"]))",
      "{",
      "session_destroy();",
      "die(error_page(\"Actividad 6\",\"<p>\".\\$json_repetido[\"error\"].\"</p>\"));",
      "}",
      "",
      "if(isset(\\$json_repetido[\"mensaje_baneo\"]))",
      "{",
      "session_unset();//Me deslogueo",
      "\\$_SESSION[\"mensaje_seguridad\"]=\"Usted ya no se encuentra registrado en la BD\";",
      "header(\"Location:index.php\");",
      "exit;",
      "}",
      "",
      "\\$error_nombre_corto=\\$json_repetido[\"repetido\"];",
      "}",
      "\\$error_descripcion=\\$_POST[\"descripcion\"]==\"\";",
      "\\$error_PVP=\\$_POST[\"PVP\"]==\"\" || !is_numeric(\\$_POST[\"PVP\"]) || \\$_POST[\"PVP\"]<=0;",
      "",
      "    \\$error_form=\\$error_cod || \\$error_nombre_corto || \\$error_descripcion || \\$error_PVP;",
      "",
      "    if(!\\$error_form)",
      "    {",
      "    //inserto y salto con mensaje",
      "",
      "    \\$headers[]='Authorization: Bearer ' .\\$_SESSION[\"token\"];",
      "    \\$url=DIR_SERV.\"/producto/insertar\";",
      "    unset(\\$_POST[\"btnContNuevo\"]);",
      "    \\$respuesta=consumir_servicios_JWT_REST(\\$url,\"POST\",\\$headers,\\$_POST);",
      "    \\$json_insertar=json_decode(\\$respuesta,true);",
      "    if(!\\$json_insertar)",
      "    {",
      "    session_destroy();",
      "    die(error_page(\"Actividad 6\",\"<p>Error consumiendo el servico rest: <strong>\".\\$url.\"</strong></p>\"));",
      "    }",
      "",
      "    if(isset(\\$json_insertar[\"no_auth\"]))",
      "    {",
      "    session_unset();",
      "    \\$_SESSION[\"mensaje_seguridad\"]=\"El tiempo de sesión de la API ha caducado\";",
      "    header(\"Location:index.php\");",
      "    exit;",
      "    }",
      "",
      "    if(isset(\\$json_insertar[\"error\"]))",
      "    {",
      "    session_destroy();",
      "    die(error_page(\"Actividad 6\",\"<p>\".\\$json_insertar[\"error\"].\"</p>\"));",
      "    }",
      "",
      "    if(isset(\\$json_insertar[\"mensaje_baneo\"]))",
      "    {",
      "    session_unset();//Me deslogueo",
      "    \\$_SESSION[\"mensaje_seguridad\"]=\"Usted ya no se encuentra registrado en la BD\";",
      "    header(\"Location:index.php\");",
      "    exit;",
      "    }",
      "",
      "    \\$_SESSION[\"mensaje\"]=\"¡¡ Producto insertado con éxito !!\";",
      "    header(\"Location:index.php\");",
      "    exit;",
      "",
      "    }",
      "",
      "    }"
    ]
  },
  "__btn_cont_editar": {
    "prefix": "__btn_cont_editar",
    "body": [
      "if(isset(\\$_POST[\"btnContEditar\"]))",
      "{",
      "",
      "",
      "\\$error_nombre_corto=\\$_POST[\"nombre_corto\"]==\"\";",
      "if(!\\$error_nombre_corto)",
      "{",
      "\\$headers[] = 'Authorization: Bearer '.\\$_SESSION[\"token\"];",
      "\\$url=DIR_SERV.\"/repetido/producto/nombre_corto/\".urlencode(\\$_POST[\"nombre_corto\"]).\"/cod/\".urlencode(\\$_POST[\"cod\"]);",
      "\\$respuesta=consumir_servicios_JWT_REST(\\$url,\"GET\",\\$headers);",
      "\\$json_repetido=json_decode(\\$respuesta,true);",
      "if(!\\$json_repetido)",
      "{",
      "session_destroy();",
      "die(error_page(\"Actividad 6\",\"<p>Error consumiendo el servico rest: <strong>\".\\$url.\"</strong></p>\"));",
      "}",
      "",
      "if(isset(\\$json_repetido[\"no_auth\"]))",
      "{",
      "session_unset();",
      "\\$_SESSION[\"mensaje_seguridad\"]=\"El tiempo de sesión de la API ha caducado\";",
      "header(\"Location:index.php\");",
      "exit;",
      "}",
      "",
      "if(isset(\\$json_repetido[\"error\"]))",
      "{",
      "session_destroy();",
      "die(error_page(\"Actividad 6\",\"<p>\".\\$json_repetido[\"error\"].\"</p>\"));",
      "}",
      "",
      "if(isset(\\$json_repetido[\"mensaje_baneo\"]))",
      "{",
      "session_unset();//Me deslogueo",
      "\\$_SESSION[\"mensaje_seguridad\"]=\"Usted ya no se encuentra registrado en la BD\";",
      "header(\"Location:index.php\");",
      "exit;",
      "}",
      "",
      "\\$error_nombre_corto=\\$json_repetido[\"repetido\"];",
      "}",
      "\\$error_descripcion=\\$_POST[\"descripcion\"]==\"\";",
      "\\$error_PVP=\\$_POST[\"PVP\"]==\"\" || !is_numeric(\\$_POST[\"PVP\"]) || \\$_POST[\"PVP\"]<=0;",
      "",
      "    \\$error_form=\\$error_nombre_corto || \\$error_descripcion || \\$error_PVP;",
      "",
      "    if(!\\$error_form)",
      "    {",
      "    //edito y salto con mensaje",
      "    \\$headers[]='Authorization: Bearer ' .\\$_SESSION[\"token\"];",
      "    \\$url=DIR_SERV.\"/producto/actualizar/\".urlencode(\\$_POST[\"cod\"]);",
      "    unset(\\$_POST[\"btnContEditar\"]);",
      "    unset(\\$_POST[\"cod\"]);",
      "    \\$respuesta=consumir_servicios_JWT_REST(\\$url,\"PUT\",\\$headers,\\$_POST);",
      "    \\$json_actualizar=json_decode(\\$respuesta,true);",
      "    if(!\\$json_actualizar)",
      "    {",
      "    session_destroy();",
      "    die(error_page(\"Actividad 6\",\"<p>Error consumiendo el servico rest: <strong>\".\\$url.\"</strong></p>\"));",
      "    }",
      "",
      "    if(isset(\\$json_actualizar[\"no_auth\"]))",
      "    {",
      "    session_unset();",
      "    \\$_SESSION[\"mensaje_seguridad\"]=\"El tiempo de sesión de la API ha caducado\";",
      "    header(\"Location:index.php\");",
      "    exit;",
      "    }",
      "",
      "    if(isset(\\$json_actualizar[\"error\"]))",
      "    {",
      "    session_destroy();",
      "    die(error_page(\"Actividad 6\",\"<p>\".\\$json_actualizar[\"error\"].\"</p>\"));",
      "    }",
      "",
      "    if(isset(\\$json_actualizar[\"mensaje_baneo\"]))",
      "    {",
      "    session_unset();//Me deslogueo",
      "    \\$_SESSION[\"mensaje_seguridad\"]=\"Usted ya no se encuentra registrado en la BD\";",
      "    header(\"Location:index.php\");",
      "    exit;",
      "    }",
      "",
      "    \\$_SESSION[\"mensaje\"]=\"¡¡ Producto actualizado con éxito !!\";",
      "    header(\"Location:index.php\");",
      "    exit;",
      "",
      "    }",
      "",
      "    }"
    ]
  },
  "__btn_detalles": {
    "prefix": "__btn_detalles",
    "body": [
      "if(isset(\\$_POST[\"btnDetalles\"]) || isset(\\$_POST[\"btnEditar\"]))",
      "{",
      "if(isset(\\$_POST[\"btnDetalles\"]))",
      "\\$cod=\\$_POST[\"btnDetalles\"];",
      "else",
      "\\$cod=\\$_POST[\"btnEditar\"];",
      "",
      "\\$headers[] = 'Authorization: Bearer '.\\$_SESSION[\"token\"];",
      "\\$url=DIR_SERV.\"/producto/\".urlencode(\\$cod);",
      "\\$respuesta=consumir_servicios_JWT_REST(\\$url,\"GET\",\\$headers);",
      "\\$json_detalles=json_decode(\\$respuesta,true);",
      "if(!\\$json_detalles)",
      "{",
      "session_destroy();",
      "die(error_page(\"Actividad 6\",\"<p>Error consumiendo el servico rest: <strong>\".\\$url.\"</strong></p>\"));",
      "}",
      "",
      "if(isset(\\$json_detalles[\"no_auth\"]))",
      "{",
      "session_unset();",
      "\\$_SESSION[\"mensaje_seguridad\"]=\"El tiempo de sesión de la API ha caducado\";",
      "header(\"Location:index.php\");",
      "exit;",
      "}",
      "",
      "if(isset(\\$json_detalles[\"error\"]))",
      "{",
      "session_destroy();",
      "die(error_page(\"Actividad 6\",\"<p>\".\\$json_detalles[\"error\"].\"</p>\"));",
      "}",
      "",
      "if(isset(\\$json_detalles[\"mensaje_baneo\"]))",
      "{",
      "session_unset();//Me deslogueo",
      "\\$_SESSION[\"mensaje_seguridad\"]=\"Usted ya no se encuentra registrado en la BD\";",
      "header(\"Location:index.php\");",
      "exit;",
      "}",
      "}"
    ]
  },
  "__btn_cont_borrar": {
    "prefix": "__btn_cont_borrar",
    "body": [
      "if(isset(\\$_POST[\"btnContBorrar\"]))",
      "{",
      "\\$headers[] = 'Authorization: Bearer '.\\$_SESSION[\"token\"];",
      "\\$url=DIR_SERV.\"/producto/borrar/\".urlencode(\\$_POST[\"btnContBorrar\"]);",
      "\\$respuesta=consumir_servicios_JWT_REST(\\$url,\"DELETE\",\\$headers);",
      "\\$json_borrar=json_decode(\\$respuesta,true);",
      "if(!\\$json_borrar)",
      "{",
      "session_destroy();",
      "die(error_page(\"Actividad 6\",\"<p>Error consumiendo el servico rest: <strong>\".\\$url.\"</strong></p>\"));",
      "}",
      "",
      "if(isset(\\$json_borrar[\"no_auth\"]))",
      "{",
      "session_unset();",
      "\\$_SESSION[\"mensaje_seguridad\"]=\"El tiempo de sesión de la API ha caducado\";",
      "header(\"Location:index.php\");",
      "exit;",
      "}",
      "",
      "if(isset(\\$json_borrar[\"error\"]))",
      "{",
      "session_destroy();",
      "die(error_page(\"Actividad 6\",\"<p>\".\\$json_borrar[\"error\"].\"</p>\"));",
      "}",
      "",
      "if(isset(\\$json_borrar[\"mensaje_baneo\"]))",
      "{",
      "session_unset();//Me deslogueo",
      "\\$_SESSION[\"mensaje_seguridad\"]=\"Usted ya no se encuentra registrado en la BD\";",
      "header(\"Location:index.php\");",
      "exit;",
      "}",
      "",
      "\\$_SESSION[\"mensaje\"]=\"¡¡ Producto borrado con éxito !!\";",
      "header(\"Location:index.php\");",
      "exit;",
      "",
      "}"
    ]
  }
}